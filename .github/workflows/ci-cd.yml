name: Automatic Version Tagging

on:
  push:
    branches:
      - master  # Set the branch where versioning should occur

jobs:
  tag-version:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Node.js (optional, if you need node/npm)
      uses: actions/setup-node@v3
      with:
        node-version: '14'

    - name: Get the latest tag or create an initial tag
      run: |
        TAGS=$(git tag -l)
        if [ -z "$TAGS" ]; then
          NEW_TAG="v0.0.1"
        else
          # Sort tags numerically to get the latest tag
          LATEST_TAG=$(echo "$TAGS" | sort -V | tail -n 1)
          # Increment the PATCH version
          VERSION_ARRAY=(${LATEST_TAG//./ })
          PATCH=${VERSION_ARRAY[2]}
          NEW_PATCH=$((PATCH + 1))
          NEW_TAG="${VERSION_ARRAY[0]}.${VERSION_ARRAY[1]}.$NEW_PATCH"
        fi
        echo "New version is: $NEW_TAG"
        echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

    - name: Check if tag exists and create new tag
      run: |
        # Check if the new tag already exists on the remote
        TAG_EXISTS=$(git ls-remote --tags origin $NEW_TAG)
        if [ -z "$TAG_EXISTS" ]; then
          git tag $NEW_TAG
          git push origin $NEW_TAG
          echo "Tag $NEW_TAG pushed."
        else
          echo "Tag $NEW_TAG already exists, skipping tag creation."
        fi
